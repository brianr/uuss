import sys

import simplejson
import zlib

from lolapps.util.adapters import chunking
import uuss
from uuss.server import model

fixed_userstates = {'100000037613452': 1, '1565767700': 1, '100000145328786': 1, '100001642655053': 1, 'vstvwww::vz::net:VxRTFjZ8nv6rrIV0iwMWaA': 1, '100000042964863': 1, '1816585695': 1, '100001337372021': 1, '100000197143454': 1, '100001728857622': 1, '100001306500194': 1, '1291016364': 1, '100001545202233': 1, '100000389510616': 1, '100000978798952': 1, '100000046668439': 1, '100000870909736': 1, '100000856184853': 1, 'vimv62335375': 1, '100000322533746': 1, '100000436833110': 1, '100001242654417': 1, '1746161784': 1, 'vstvwww::vz::net:djmq4ppcz-ncrxmgzuv_ma': 1, '1605053165': 1, '100001294198253': 1, '1159608617': 1, '1435758974': 1, '100001730617331': 1, '100001951545718': 1, '530775437': 1, '1000283987': 1, '1186914925': 1, '100000701227186': 1, '100001446300304': 1, '100001133778330': 1, '1647595002': 1, 'vstvwww::vz::net:d3LGPHVvOZaupb_qZBd2Zg': 1, '711701508': 1, '100000433151391': 1, '1746559845': 1, '100001597398907': 1, '100001088732580': 1, '100001218957348': 1, '1348450094': 1, '100001143321711': 1, '1471339018': 1, '100000699737922': 1, 'vstvwww::vz::net:l2knplvdtv2cbscrteikyg': 1, '100001911671152': 1, '1712034543': 1, '100001908135739': 1, '100000599659714': 1, '100001030296444': 1, '100000930248313': 1, 'vstvwww::vz::net:ieuwxauoyt0mtwgrwh-9iw': 1, '100000212287410': 1, '100001907340397': 1, '100000526114594': 1, 'vscvwww::schuelervz::net:CjKiEv0HA6aRT5OxQXSwZQ': 1, '100000191251154': 1, '100000165845709': 1, '100001287707604': 1, '100001142254386': 1, '1236609615': 1, '100000280570051': 1, '100000843077753': 1, '100001428158680': 1, '100000727935923': 1, '100000734500071': 1, '100001839426149': 1, '100001465219855': 1, '1431975831': 1, 'vstvwww::vz::net:NrozDGJaY_Qc_cXSF0earQ': 1, '100000509188038': 1, '100000824911425': 1, '100000706847577': 1, '100001096117472': 1, '100001062966991': 1, '100000629036861': 1, '100001993796187': 1, '1187457742': 1, '1606894267': 1, '100000678556025': 1, '1052514883': 1, '100001274934828': 1, '100001029128149': 1, '100000388282004': 1, 'vimv58431892': 1, '1620716744': 1, '100000723373694': 1, '100000967486315': 1, '100000642680364': 1, '1481867068': 1, '1683428013': 1, '100000328983193': 1, '100000516515462': 1, '1567078101': 1, '100001828567389': 1, '1705682317': 1, '1668944178': 1, '206700271': 1, '100001155289795': 1, '100000163447398': 1, '1470412964': 1, '100001508889610': 1, '717483583': 1, '100001080836916': 1, '100000002892909': 1, '100001487182341': 1, '1591504009': 1, '100000232203161': 1, 'vstvwww::vz::net:9SLYngaGkYBX8FCXRR-Cgw': 1, '100000129369320': 1, '100000030798593': 1, '100001204103231': 1, '1379868731': 1, '100001944589800': 1, '1140384379': 1, '1665181991': 1, '100001051943676': 1, '100000385146439': 1, '100000701187645': 1, '1001325196': 1, '100001159231639': 1, '100001457600430': 1, '1608645720': 1, '1398927089': 1, '842603813': 1, '100000380085378': 1, 'vscvwww::schuelervz::net:6hrFLzTcjmqgGUsmOtOlLg': 1, '618538047': 1, '100000707248027': 1, '100000108949079': 1, '100000596367976': 1, '1743240982': 1, '1334021499': 1, '602762716': 1, '1022606809': 1, '100001402159280': 1, '1613941661': 1, '1042521247': 1, '512208315': 1, '1052032033': 1, 'vimv69746786': 1, '100001802856434': 1, '100000848931468': 1, '100001323547759': 1, '100001048273085': 1, '1644434970': 1, '1453171309': 1, '1764352660': 1, '1341405816': 1, '100001219760916': 1, '100000636160198': 1, '100000923291815': 1, '100001341177707': 1, '1300185290': 1, '1614942442': 1, '100000138741041': 1, '1452881767': 1, '1560559711': 1, '1580510102': 1, '100000587193410': 1, '100001124943135': 1, '100000186036348': 1, '100001367419463': 1, '100000683713625': 1, '100001300274272': 1, '100000299029785': 1, '100000675669342': 1, '100000612234281': 1, '100000409840584': 1, '100001468015143': 1, '1122204706': 1, '100001213713524': 1, '100000848746702': 1, '100001065957321': 1, '1569382039': 1, '100000895810495': 1, '1540775000': 1, '100001119581783': 1, '100001065249799': 1, '100001144363642': 1, '1498807524': 1, '100000875302709': 1, '100000036057821': 1, '1348375620': 1, '702378816': 1, '1365698352': 1, '100001949916050': 1, '100000321978980': 1, '100000417201137': 1, '100001174891830': 1, '100001093653337': 1, '100000941576692': 1, '100000005257921': 1, '1850955343': 1, '100000941988148': 1, '100000143235995': 1, '100000425856576': 1, '100001748378939': 1, '672805465': 1, '1307654922': 1, '100001470619331': 1, '1272676412': 1, '100001564572037': 1, '100000630884580': 1, '100001545526861': 1, '1261931108': 1, '727934262': 1, '100001609408401': 1, 'vscvwww::schuelervz::net:djaHsMHcXGiTOqaLJ8ap9g': 1, '100000190684929': 1, '100001253831270': 1, '100001067468934': 1, '1174576213': 1, 'vstvwww::vz::net:87JZTkkPeLzurzY8FOyKtw': 1, 'vscvwww::schuelervz::net:uE0WqMiYo6cvHRqP_9HOyg': 1, '1418143893': 1, '100001694586721': 1, '100001824768167': 1, '1408023116': 1, '1170583432': 1, '100001659221402': 1, '100001841216001': 1, '100000095998347': 1, '100000501837424': 1, '600094444': 1, '100000144180973': 1, '1198495852': 1, '754204626': 1, '1510266384': 1, '100001891844359': 1, '100001126100861': 1, '1064738410': 1, '1254017122': 1, '100000622740883': 1, '100000009265636': 1, '1839074053': 1, '773433356': 1, '100000733784955': 1, '100001856012854': 1, '719889411': 1, '811228901': 1, '835564428': 1, '100001459042445': 1, '100000896420388': 1, '100001003152277': 1, '100001244692407': 1, '100001596053150': 1, '1386903812': 1, '100000573531628': 1, '1310822303': 1, '100000169996027': 1, '100000838940938': 1, '1019775085': 1, '1411060911': 1, '100001124786554': 1, '638330891': 1, '100001650755317': 1, '100001743211210': 1, '1831389454': 1, '100001952902124': 1, '1570969790': 1, '100001788976751': 1, '100001787531962': 1, '100000105300555': 1, '1063101834': 1, '100001335744984': 1, '764628481': 1, '100001342555654': 1, '100001246062916': 1, '100000565813876': 1, '100000705432715': 1, '100001456888901': 1, '100001958149434': 1, '100000297584237': 1, '100000386989147': 1, 'vstvwww::vz::net:HKSpv9HCzTdmla8HQVk3Wg': 1, '1629347390': 1, '100000559225361': 1, '100001629408662': 1, '1757659273': 1, '1517516548': 1, '1157144327': 1, '100001547835585': 1, '662231315': 1, '100000204679743': 1, '100000066456571': 1, '641963349': 1, '1232740861': 1, '100002004878818': 1, '100000097592964': 1, '1350360017': 1, '712628602': 1, '1494627923': 1, '100002127190859': 1, '765209730': 1, '805231838': 1, '100001933352662': 1, '1066689111': 1, '100001706163981': 1, '1001106793': 1, '100000743897421': 1, '100000010565079': 1, '1497946832': 1, '100000856844505': 1, '500549257': 1, '100000923145832': 1, '100001208570590': 1, 'vstvwww::vz::net:yA0U82NfAH-mwNbkRGr2EQ': 1, '100000688721303': 1, '100001084511434': 1, '100000177195208': 1, '100001109528567': 1, '1267910337': 1, '100000348921179': 1, '100001069355754': 1, '100001901580888': 1, '536434819': 1, '100001276045454': 1, '1706726585': 1, 'vscvwww::schuelervz::net:4QDRPboLMQ6aNUdSWapRKA': 1, '1474874234': 1, 'vimv70186249': 1, '1585480394': 1, '1553322699': 1, '1624004787': 1, '100000484957374': 1, '100000577430355': 1, '100000625992316': 1, '100001643771075': 1, '100000028214242': 1, '100001416313957': 1, '100001145494351': 1, '100001688646883': 1, '100000408176550': 1, '754683515': 1, '1540238507': 1, '1829921486': 1, '100001872206164': 1, '100000136608482': 1, 'vstvwww::vz::net:elU3n3qHj_Ms8Qie5JqwGw': 1, '726826327': 1, '100001142267142': 1, '100001440925929': 1, '1049451158': 1, '100000019291850': 1, '100000889721313': 1, '100001321328178': 1, '100001708850871': 1, 'vimv70026045': 1, '100000260145773': 1, '100001977061021': 1, '533401223': 1, '100000569670112': 1, '100000124159434': 1, '100000141290399': 1, '100000485276205': 1}

def fix_state(uid):
    userstate = model.dane.userstate
    try:
        userstate.get(uid)
        print "State OK for %r" % uid
    except uuss.WrongUserIdException, e:
        if not 'wrong user_id in state' in e.args[0]:
            raise
        print "Wrong user_id in state for %r" % uid
        
        user_state = model.dane.UserState.get(uid)
        try:
            state = chunking.reconstitute_chunks(user_state.state, True)
        except:
            chunking_exc = sys.exc_info()
            try:
                state = simplejson.loads(zlib.decompress(user_state.state))
            except Exception, e:
                print "Chunking and original formats failed"
                print e
                print chunking_exc

        try:
            uuss.check_user_id(uid, state)
        except:
            print "User ID for %r incorrect in DB\n%r" % (uid, state)

        state = userstate._mc.get(userstate._make_key(uid), lazy_load_chunks=True)
        try:
            uuss.check_user_id(uid, state)
        except:
            print "UserID for %r incorrect in Memcache\n%r" % (uid, state)
            
        if uid in fixed_userstates:
            print "WARNING: uid %r has been fixed %r times before" % (uid, fixed_userstates[uid])
        else:
            fixed_userstates[uid] = 0
        fixed_userstates[uid] += 1
        userstate.save(uid, {'user_id': uid})
        print "Fixed state for %r" % uid
